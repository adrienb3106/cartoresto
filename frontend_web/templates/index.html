{% extends "base.html" %}

{% block content %}
<h1>Restaurants</h1>

<!-- Lien vers le formulaire -->
<p><a href="/add-restaurant" style="font-weight:bold; color:#007bff;">➕ Ajouter un restaurant</a></p>

<div style="display: flex; gap: 20px;">
    <!-- Colonne gauche : liste + recherche -->
    <div style="flex: 1;">
        <!-- Barre de recherche -->
        <form id="searchForm">
            <input type="text" id="searchInput" placeholder="Rechercher un restaurant" style="width: 100%; margin-bottom: 10px;">
            <button type="submit" style="width: 100%;">Rechercher</button>
        </form>

        <!-- Liste des restaurants -->
        <ul id="restaurantList" style="list-style: none; padding: 0;">
            {% for r in restaurants %}
            <li style="margin-bottom: 5px;"><a href="/restaurant/{{ r.id }}">{{ r.nom }}</a></li>
            {% endfor %}
        </ul>
    </div>

    <!-- Colonne droite : carte -->
    <div style="flex: 2;">
        <div id="map-all" style="height: 600px; width: 100%;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // ===== Recherche =====
    const form = document.getElementById("searchForm");
    const input = document.getElementById("searchInput");
    const list = document.getElementById("restaurantList");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const query = input.value.trim();
        if (!query) return;

        try {
            const res = await fetch(`http://127.0.0.1:8000/restaurants/search?name=${encodeURIComponent(query)}`);
            if (!res.ok) throw new Error("Erreur réseau");
            const data = await res.json();

            list.innerHTML = "";
            if (data.length === 0) {
                list.innerHTML = "<li>Aucun restaurant trouvé</li>";
                return;
            }

            data.forEach(r => {
                const li = document.createElement("li");
                li.style.marginBottom = "5px";
                li.innerHTML = `<a href="/restaurant/${r.id}">${r.nom}</a>`;
                list.appendChild(li);
            });
        } catch (err) {
            console.error(err);
            list.innerHTML = "<li>Erreur lors de la recherche</li>";
        }
    });

    // ===== Carte =====
    const map = L.map('map-all').setView([48.8566, 2.3522], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
    }).addTo(map);

    {% for r in restaurants %}
        L.marker([{{ r.localisation.latitude }}, {{ r.localisation.longitude }}])
         .addTo(map)
         .bindPopup('<b>{{ r.nom }}</b><br>{{ r.informations.category }}');
    {% endfor %}
});
</script>
{% endblock %}
